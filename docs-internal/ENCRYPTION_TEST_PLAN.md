# 암호화 기능 테스트 계획서

> 작성일: 2026-02-08
> 기반 문서: DATA_ENCRYPTION_SPEC.md v2.0
> 목적: 기존 데이터를 안전하게 보존하면서 암호화 기능 테스트

---

## 목차

1. [테스트 환경 구성](#1-테스트-환경-구성)
2. [Firebase 테스트 영역](#2-firebase-테스트-영역)
3. [테스트 단계별 계획](#3-테스트-단계별-계획)
4. [롤백 절차](#4-롤백-절차)
5. [체크리스트](#5-체크리스트)

---

## 1. 테스트 환경 구성

### 1.1 전체 구조

```
┌─────────────────────────────────────────────────────────────────┐
│  테스트 환경 격리 구조                                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [원본 프로젝트] ~/sample-log-electron/                         │
│    └── 절대 수정하지 않음 (운영 데이터 보존)                    │
│                                                                 │
│  [테스트 프로젝트] ~/sample-log-electron-test/                  │
│    ├── 코드: 원본 복사 + 암호화 기능 개발                       │
│    ├── 로컬 데이터: 테스트 전용 JSON (샘플 5건)                 │
│    └── Firebase: 테스트 전용 컬렉션 (test_ 접두사)              │
│                                                                 │
│  [Firebase]                                                     │
│    ├── soilSamples_2026        ← 운영 (건드리지 않음)           │
│    ├── waterSamples_2026       ← 운영 (건드리지 않음)           │
│    ├── test_soilSamples_2026   ← 테스트 전용                    │
│    └── test_waterSamples_2026  ← 테스트 전용                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 테스트 프로젝트 복사

```bash
# 1. 프로젝트 복사 (node_modules 제외)
rsync -av --exclude='node_modules' --exclude='out' \
  ~/sample-log-electron/ ~/sample-log-electron-test/

# 2. 의존성 설치
cd ~/sample-log-electron-test
npm install

# 3. 테스트 전용 Git 브랜치 생성
git checkout -b feature/encryption-test
```

### 1.3 테스트용 자동저장 폴더 분리

테스트 프로젝트는 별도의 자동저장 폴더를 사용하여 원본 데이터와 충돌 방지:

```
원본 자동저장 경로:
  ~/Library/Application Support/sample-log-electron/auto-save-*.json

테스트 자동저장 경로 (앱 시작 후 설정에서 변경):
  ~/sample-log-electron-test/test-data/auto-save-*.json
```

**방법**: 테스트 앱 실행 후 설정에서 "자동 저장 폴더"를 `~/sample-log-electron-test/test-data/`로 변경

### 1.4 테스트 데이터 준비

운영 데이터에서 **샘플 5건만** 추출하여 테스트에 사용:

```javascript
// 개발자 콘솔에서 실행 (원본 앱)
// 토양 시료 5건만 추출하여 JSON으로 내보내기
const testData = JSON.parse(localStorage.getItem('sampleLogs_soil_2026')).slice(0, 5);
console.log(JSON.stringify(testData, null, 2));
// → 결과를 test-sample-data.json 파일로 저장
```

---

## 2. Firebase 테스트 영역

### 2.1 테스트 컬렉션 전략

운영 컬렉션과 완전히 분리된 **test_ 접두사** 컬렉션 사용:

| 운영 컬렉션 | 테스트 컬렉션 |
|-------------|--------------|
| `soilSamples_2026` | `test_soilSamples_2026` |
| `waterSamples_2026` | `test_waterSamples_2026` |
| `compostSamples_2026` | `test_compostSamples_2026` |
| `heavyMetalSamples_2026` | `test_heavyMetalSamples_2026` |
| `pesticideSamples_2026` | `test_pesticideSamples_2026` |

### 2.2 firestore-db.js 테스트 모드 수정

테스트 프로젝트의 `firestore-db.js`에 테스트 모드 플래그 추가:

```javascript
// firestore-db.js 상단에 추가
const TEST_MODE = true;  // ⚠️ 테스트 완료 후 반드시 false로 변경
const TEST_PREFIX = 'test_';

// 기존 getCollectionName 함수 수정
function getCollectionName(sampleType, year) {
    const baseName = `${COLLECTION_MAP[sampleType]}_${year}`;
    return TEST_MODE ? `${TEST_PREFIX}${baseName}` : baseName;
}
```

### 2.3 Firebase 보안 규칙 (테스트 컬렉션)

기존 규칙에 테스트 컬렉션 허용 추가:

```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 기존 운영 규칙 유지
    // ...

    // 테스트 컬렉션 (test_ 접두사)
    match /test_{collection}/{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
```

### 2.4 테스트 데이터 초기 세팅

```javascript
// 테스트 앱의 개발자 콘솔에서 실행
// 테스트 컬렉션에 샘플 데이터 5건 업로드

async function seedTestData() {
    const testRecords = [
        {
            id: 'test-soil-001',
            receptionNumber: 'TEST-2026-001',
            date: '2026-02-08',
            name: '테스트 홍길동',
            phone: '010-0000-0001',
            address: '경북 봉화군 봉화읍 테스트리 1',
            purpose: '논',
            isCompleted: false
        },
        {
            id: 'test-soil-002',
            receptionNumber: 'TEST-2026-002',
            date: '2026-02-08',
            name: '테스트 김철수',
            phone: '010-0000-0002',
            address: '경북 봉화군 봉화읍 테스트리 2',
            purpose: '밭',
            isCompleted: true
        }
        // ... 3건 더 추가
    ];

    for (const record of testRecords) {
        await firestoreDb.saveDocument('soil', 2026, record.id, record);
    }
    console.log('테스트 데이터 시딩 완료');
}
```

### 2.5 테스트 완료 후 정리

```javascript
// 테스트 컬렉션 전체 삭제 함수
async function cleanupTestCollections() {
    const types = ['soil', 'water', 'compost', 'heavyMetal', 'pesticide'];
    const years = [2025, 2026];

    for (const type of types) {
        for (const year of years) {
            const collectionName = `test_${COLLECTION_MAP[type]}_${year}`;
            const snapshot = await db.collection(collectionName).get();

            const batch = db.batch();
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();

            console.log(`삭제 완료: ${collectionName} (${snapshot.size}건)`);
        }
    }
}
```

---

## 3. 테스트 단계별 계획

### Phase 0: 환경 준비

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 0: 환경 준비                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  0-1. 원본 프로젝트 데이터 백업                                  │
│       - 로컬 JSON 파일 복사                                     │
│       - localStorage 내보내기                                   │
│                                                                 │
│  0-2. 테스트 프로젝트 폴더 생성                                  │
│       - rsync로 복사 (node_modules 제외)                        │
│       - npm install                                             │
│       - Git 브랜치 생성                                         │
│                                                                 │
│  0-3. 테스트 자동저장 폴더 설정                                  │
│       - test-data/ 폴더 생성                                    │
│       - 앱 설정에서 자동저장 경로 변경                           │
│                                                                 │
│  0-4. Firebase 테스트 모드 활성화                                │
│       - firestore-db.js에 TEST_MODE = true                     │
│       - 테스트 컬렉션에 샘플 데이터 시딩                        │
│                                                                 │
│  ✅ 완료 기준: 테스트 앱이 테스트 데이터로 정상 동작            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Phase 1: 암호화 모듈 단위 테스트

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 1: crypto-utils.js 단위 테스트                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Firebase/로컬파일 건드리지 않고 개발자 콘솔에서만 테스트       │
│                                                                 │
│  1-1. 키 파일 생성 테스트                                       │
│       - generateKeyFileContent() 호출                           │
│       - 32바이트 Base64 출력 확인                               │
│                                                                 │
│  1-2. 비밀번호 검증 테스트                                      │
│       - validatePassword() 각 조건별 테스트                     │
│       - 약함/보통/강함 등급 확인                                │
│                                                                 │
│  1-3. 마스터 키 생성 테스트                                     │
│       - createMasterKey(password, keyFile) 호출                 │
│       - CryptoKey 객체 반환 확인                                │
│       - 동일 입력 → 동일 키 생성 확인                           │
│       - 다른 입력 → 다른 키 생성 확인                           │
│                                                                 │
│  1-4. 문자열 암호화/복호화 테스트                               │
│       - "테스트 문자열" 암호화 → 복호화 → 원본 일치             │
│       - 한글, 특수문자, 긴 문자열 테스트                        │
│       - 잘못된 키로 복호화 시 null 반환 확인                    │
│                                                                 │
│  1-5. 빈 값/null 처리 테스트                                    │
│       - encrypt(null) → null                                    │
│       - encrypt("") → null                                      │
│       - decrypt(잘못된IV, 잘못된CT, key) → null                  │
│                                                                 │
│  ✅ 완료 기준: 모든 단위 테스트 통과                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Phase 2: 로컬 백업 암호화 통합 테스트

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 2: 로컬 백업 암호화 테스트                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  테스트 데이터(5건)로만 수행                                    │
│                                                                 │
│  2-1. 전체 데이터 암호화 테스트                                  │
│       - encryptBackup(testData, key, salt) 호출                 │
│       - 결과 JSON 구조 확인 (version, algorithm, iv, ct 등)     │
│       - .enc 파일로 저장                                        │
│                                                                 │
│  2-2. 전체 데이터 복호화 테스트                                  │
│       - .enc 파일 읽기                                          │
│       - decryptBackup(encrypted, password, keyFile) 호출        │
│       - 원본 데이터와 비교 → 완전 일치 확인                     │
│                                                                 │
│  2-3. 잘못된 비밀번호 테스트                                    │
│       - 다른 비밀번호로 복호화 시도 → 실패 확인                 │
│       - 다른 키 파일로 복호화 시도 → 실패 확인                  │
│       - 에러 메시지 적절한지 확인                               │
│                                                                 │
│  2-4. 자동 저장 흐름 테스트                                     │
│       - performAutoSave() → .enc 파일 생성 확인                 │
│       - loadFromAutoSaveFile() → .enc 파일 복호화 확인          │
│       - 앱 재시작 → 비밀번호 입력 → 데이터 복원 확인           │
│                                                                 │
│  2-5. 기존 .json → .enc 마이그레이션 테스트                     │
│       - 테스트 .json 파일 준비                                  │
│       - 마이그레이션 실행 → .enc 생성, .json.backup 생성 확인   │
│       - .enc 복호화 → 원본 .json 내용과 일치 확인              │
│                                                                 │
│  ✅ 완료 기준: 암호화 저장/복원 정상, 마이그레이션 정상          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Phase 3: Firebase 필드 암호화 통합 테스트

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 3: Firebase 필드 암호화 테스트                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  테스트 컬렉션(test_ 접두사)에서만 수행                         │
│                                                                 │
│  3-1. 레코드 암호화 테스트                                      │
│       - encryptRecord(testRecord, key) 호출                     │
│       - _enc 필드 생성 확인                                     │
│       - 민감 필드(name, phone, address) 제거 확인               │
│       - 비민감 필드(id, date, purpose) 평문 유지 확인           │
│                                                                 │
│  3-2. 레코드 복호화 테스트                                      │
│       - decryptRecord(encryptedRecord, key) 호출                │
│       - 원본 레코드와 완전 일치 확인                            │
│                                                                 │
│  3-3. Firebase 저장/로드 테스트                                  │
│       - 암호화된 레코드를 test_ 컬렉션에 저장                   │
│       - Firebase 콘솔에서 민감 필드 암호화 확인                 │
│       - 로드 후 복호화 → 원본 일치 확인                        │
│                                                                 │
│  3-4. 하위 호환성 테스트                                        │
│       - 평문 레코드(_enc 없음) 로드 → 그대로 반환 확인         │
│       - 평문 레코드 수정/저장 → 암호화되어 저장 확인           │
│                                                                 │
│  3-5. 배치 암호화 테스트                                        │
│       - encryptRecords(5건, key) → 전체 암호화 확인             │
│       - decryptRecords(5건, key) → 전체 복호화 확인             │
│                                                                 │
│  ✅ 완료 기준: Firebase 테스트 컬렉션에서 정상 동작              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Phase 4: UI 및 사용자 흐름 테스트

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 4: UI 및 사용자 흐름 테스트                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  4-1. 최초 실행 시나리오                                        │
│       - 키 파일 없음 → 설정 위저드 표시                         │
│       - 비밀번호 설정 화면 → 강도 표시 확인                     │
│       - 키 파일 자동 생성 확인                                  │
│       - 키 파일 백업 안내 팝업 확인                             │
│                                                                 │
│  4-2. 일반 실행 시나리오                                        │
│       - 비밀번호 입력 화면 표시                                 │
│       - 올바른 비밀번호 → 앱 진입                               │
│       - 잘못된 비밀번호 → 에러 메시지                           │
│       - 3회 실패 → 경고 표시                                    │
│                                                                 │
│  4-3. 데이터 조작 시나리오                                      │
│       - 새 시료 접수 → 저장 → Firebase 암호화 확인              │
│       - 기존 시료 수정 → 저장 → 암호화 유지 확인               │
│       - 시료 삭제 → 정상 삭제 확인                              │
│       - 자동 저장 → .enc 파일 생성 확인                         │
│                                                                 │
│  4-4. 키 파일 관리 시나리오                                     │
│       - 설정 > 보안 > 키 파일 경로 확인                         │
│       - 키 파일 백업 기능                                       │
│       - 키 파일 위치 변경                                       │
│                                                                 │
│  ✅ 완료 기준: 전체 사용자 흐름 정상 동작                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Phase 5: 성능 및 엣지 케이스 테스트

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 5: 성능 및 엣지 케이스                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  5-1. 성능 측정                                                 │
│       - PBKDF2 600,000회 키 유도 시간 측정 (목표: 150~300ms)   │
│       - 100건 데이터 암호화 시간                                │
│       - 100건 데이터 복호화 시간                                │
│       - .enc 파일 크기 vs .json 파일 크기 비교                  │
│                                                                 │
│  5-2. 대용량 데이터 테스트                                      │
│       - 500건 이상 데이터 암호화/복호화                         │
│       - 자동 저장 시 성능 저하 여부                             │
│                                                                 │
│  5-3. 엣지 케이스                                               │
│       - 네트워크 끊긴 상태에서 암호화 저장                      │
│       - 앱 강제 종료 후 데이터 복구                             │
│       - 키 파일이 삭제된 상태에서 앱 실행                       │
│       - .enc 파일 손상 시 에러 처리                             │
│                                                                 │
│  ✅ 완료 기준: 성능 허용 범위 내, 엣지 케이스 안전 처리          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 롤백 절차

### 테스트 중 문제 발생 시

```
┌─────────────────────────────────────────────────────────────────┐
│  롤백 순서                                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 테스트 앱 즉시 종료                                         │
│                                                                 │
│  2. Firebase 테스트 데이터 정리                                  │
│     → cleanupTestCollections() 실행                             │
│     → 운영 컬렉션은 test_ 접두사로 격리되어 있어 안전           │
│                                                                 │
│  3. 테스트 프로젝트 폴더 삭제                                   │
│     rm -rf ~/sample-log-electron-test                           │
│                                                                 │
│  4. 원본 프로젝트 확인                                          │
│     → 원본은 전혀 수정하지 않았으므로 그대로 사용               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 테스트 성공 후 운영 적용

```
┌─────────────────────────────────────────────────────────────────┐
│  운영 적용 순서                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 테스트 프로젝트에서 TEST_MODE = false 변경                  │
│     모든 Phase 테스트 통과 확인                                 │
│                                                                 │
│  2. 원본 프로젝트에 코드 머지                                   │
│     - 테스트 브랜치의 변경사항을 원본에 적용                    │
│     - 또는 원본 프로젝트에서 동일한 코드 작성                   │
│                                                                 │
│  3. 원본 데이터 백업 (한 번 더)                                  │
│     - 로컬 JSON 파일 복사                                       │
│     - Firebase 내보내기 (선택)                                  │
│                                                                 │
│  4. 운영 앱에서 암호화 활성화                                   │
│     - 비밀번호 설정                                             │
│     - 키 파일 생성                                              │
│     - 기존 .json → .enc 자동 마이그레이션                       │
│     - Firebase 점진적 암호화 시작                               │
│                                                                 │
│  5. 1주일 모니터링                                              │
│     - 데이터 정상 저장/로드 확인                                │
│     - 자동 저장 .enc 파일 정상 생성 확인                        │
│     - 문제 발생 시 .json.backup에서 복원 가능                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 체크리스트

### Phase 0: 환경 준비
- [ ] 원본 로컬 JSON 파일 백업 완료
- [ ] 테스트 프로젝트 폴더 생성 완료
- [ ] npm install 완료
- [ ] Git 테스트 브랜치 생성 완료
- [ ] 테스트 자동저장 폴더 설정 완료
- [ ] firestore-db.js TEST_MODE = true 설정 완료
- [ ] Firebase 테스트 컬렉션에 샘플 데이터 시딩 완료
- [ ] 테스트 앱 정상 실행 확인

### Phase 1: 단위 테스트
- [ ] 키 파일 생성 테스트 통과
- [ ] 비밀번호 검증 테스트 통과
- [ ] 마스터 키 생성 테스트 통과
- [ ] 문자열 암호화/복호화 테스트 통과
- [ ] 빈 값/null 처리 테스트 통과

### Phase 2: 로컬 백업 테스트
- [ ] 전체 데이터 암호화 → .enc 파일 생성
- [ ] .enc 복호화 → 원본 일치
- [ ] 잘못된 비밀번호로 복호화 실패 확인
- [ ] 잘못된 키 파일로 복호화 실패 확인
- [ ] 자동 저장 흐름 (.enc) 정상 동작
- [ ] .json → .enc 마이그레이션 정상 동작
- [ ] .json.backup 생성 확인

### Phase 3: Firebase 테스트
- [ ] 레코드 암호화 → _enc 필드 생성 확인
- [ ] 민감 필드 암호화, 비민감 필드 평문 유지
- [ ] Firebase 테스트 컬렉션 저장/로드 정상
- [ ] 평문 레코드 하위 호환 정상
- [ ] 배치 암호화/복호화 정상

### Phase 4: UI 테스트
- [ ] 최초 실행 → 설정 위저드 표시
- [ ] 비밀번호 입력 → 앱 진입
- [ ] 잘못된 비밀번호 → 에러 표시
- [ ] 시료 접수/수정/삭제 정상 동작
- [ ] 키 파일 백업/변경 기능 정상

### Phase 5: 성능 테스트
- [ ] PBKDF2 키 유도: ___ms (목표: 150~300ms)
- [ ] 100건 암호화: ___ms
- [ ] 100건 복호화: ___ms
- [ ] .enc 파일 크기: 기존 대비 ___% 증가

### 테스트 완료 후
- [ ] Firebase 테스트 컬렉션 정리 완료
- [ ] 테스트 프로젝트 폴더 삭제 (또는 보관)
- [ ] 원본 프로젝트에 코드 머지
- [ ] 운영 데이터 백업 후 암호화 활성화

---

*문서 끝*
